<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard ‚Äî lastsecondsbc</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0d0d0d;
      --surface: #1a1a1a;
      --border: #2a2a2a;
      --text: #e0e0e0;
      --muted: #666;
      --accent: #ff4d6d;
      --accent-dim: rgba(255,77,109,0.15);
      --green: #4caf50;
      --yellow: #ffc107;
      --red: #f44336;
      --blue: #2196f3;
      --mono: 'Cascadia Code', 'Consolas', 'Courier New', monospace;
    }

    body {
      min-height: 100vh;
      background: var(--bg);
      font-family: 'Segoe UI', system-ui, sans-serif;
      color: var(--text);
      display: flex;
      flex-direction: column;
    }

    /* ---- Header ---- */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.9rem 1.5rem;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    header h1 {
      font-size: 1.15rem;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    header h1 span { color: var(--accent); }

    .logout-btn {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--muted);
      font-size: 0.8rem;
      padding: 0.35rem 0.8rem;
      cursor: pointer;
      transition: color 0.2s, border-color 0.2s;
    }

    .logout-btn:hover { color: var(--text); border-color: #555; }

    /* ---- Main layout ---- */
    main {
      flex: 1;
      padding: 1.5rem;
      display: grid;
      grid-template-columns: 340px 1fr;
      grid-template-rows: auto 1fr;
      gap: 1rem;
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
    }

    /* ---- Cards ---- */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.25rem;
    }

    .card-title {
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 1rem;
    }

    /* ---- Script cards (left column) ---- */
    .scripts-col {
      grid-row: 1 / 3;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .script-card {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .script-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .script-name {
      font-size: 1rem;
      font-weight: 600;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      padding: 0.2rem 0.6rem;
      border-radius: 20px;
    }

    .badge-idle   { background: rgba(102,102,102,0.2); color: var(--muted); }
    .badge-running{ background: rgba(33,150,243,0.2);  color: var(--blue);  }
    .badge-done   { background: rgba(76,175,80,0.2);   color: var(--green); }
    .badge-error  { background: rgba(244,67,54,0.2);   color: var(--red);   }

    .dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .dot-pulse { animation: pulse 1.2s ease-in-out infinite; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.3; }
    }

    .script-desc {
      font-size: 0.82rem;
      color: var(--muted);
      line-height: 1.5;
    }

    .run-btn {
      align-self: flex-start;
      padding: 0.5rem 1.1rem;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s, opacity 0.2s;
    }

    .run-btn:hover:not(:disabled) { background: #e63d5e; }
    .run-btn:active:not(:disabled) { transform: scale(0.97); }
    .run-btn:disabled { opacity: 0.45; cursor: not-allowed; }

    /* ---- Log panel ---- */
    .log-col {
      display: flex;
      flex-direction: column;
    }

    .log-card {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .log-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .log-meta {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .clear-btn {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--muted);
      font-size: 0.72rem;
      padding: 0.2rem 0.55rem;
      cursor: pointer;
      transition: color 0.2s;
    }

    .clear-btn:hover { color: var(--text); }

    #log-output {
      flex: 1;
      background: #0a0a0a;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem 1rem;
      font-family: var(--mono);
      font-size: 0.78rem;
      line-height: 1.6;
      color: #c9d1d9;
      overflow-y: auto;
      min-height: 280px;
      max-height: 380px;
      white-space: pre-wrap;
      word-break: break-all;
    }

    #log-output .log-line-err { color: #ff6b6b; }
    #log-output .log-line-warn { color: var(--yellow); }
    #log-output .log-line-ok  { color: #9be9a8; }

    /* ---- History ---- */
    .history-col {
      overflow: hidden;
    }

    .history-table-wrap {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
    }

    thead th {
      text-align: left;
      padding: 0.4rem 0.75rem;
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
    }

    tbody tr:hover { background: rgba(255,255,255,0.02); }

    tbody td {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      vertical-align: middle;
    }

    td.script-cell { font-weight: 600; color: #ccc; font-family: var(--mono); font-size: 0.78rem; }
    td.time-cell   { color: var(--muted); font-size: 0.75rem; }
    td.dur-cell    { color: var(--muted); text-align: right; }

    .status-pill {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .status-success { background: rgba(76,175,80,0.2);  color: var(--green); }
    .status-error   { background: rgba(244,67,54,0.2);  color: var(--red);   }
    .status-running { background: rgba(33,150,243,0.2); color: var(--blue);  }

    .empty-row td {
      text-align: center;
      padding: 2rem;
      color: var(--muted);
      font-size: 0.82rem;
    }

    /* ---- Schedule slot pills ---- */
    .slot-pill {
      display: inline-block;
      padding: 0.25rem 0.65rem;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 700;
      font-family: var(--mono);
      letter-spacing: 0.04em;
    }
    .slot-learned  { background: rgba(76,175,80,0.2);   color: var(--green); border: 1px solid rgba(76,175,80,0.35); }
    .slot-psych    { background: rgba(255,193,7,0.15);  color: var(--yellow);border: 1px solid rgba(255,193,7,0.3); }
    .slot-current  { box-shadow: 0 0 0 2px currentColor; }

    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
  </style>
</head>
<body>

<header>
  <h1>last<span>seconds</span>bc <span style="color:#555;font-weight:400;font-size:0.85rem;">/ pipeline dashboard</span></h1>
  <form action="/logout" method="get" style="display:inline;">
    <button type="submit" class="logout-btn">Logout</button>
  </form>
</header>

<main>

  <!-- ---- Left: Script Controls ---- -->
  <div class="scripts-col">

    <!-- Full Pipeline ‚Äî primary action -->
    <div class="card script-card" id="card-run_pipeline" style="border-color: rgba(255,77,109,0.4);">
      <div class="card-title">Full Pipeline</div>
      <div class="script-header">
        <span class="script-name">Run Pipeline</span>
        <span class="badge badge-idle" id="badge-run_pipeline">
          <span class="dot"></span> Idle
        </span>
      </div>
      <p class="script-desc">Generates a full video end-to-end: trend research ‚Üí script ‚Üí images ‚Üí voiceover ‚Üí assembly. Takes ~5-10 min.</p>
      <button class="run-btn" id="btn-run_pipeline" onclick="runScript('run_pipeline')"
              style="background:var(--accent);font-size:0.95rem;padding:0.6rem 1.4rem;">
        ‚ñ∂ Run Full Pipeline
      </button>
    </div>

    <div class="card script-card" id="card-image_generator">
      <div class="card-title">Script</div>
      <div class="script-header">
        <span class="script-name">Image Generator</span>
        <span class="badge badge-idle" id="badge-image_generator">
          <span class="dot"></span> Idle
        </span>
      </div>
      <p class="script-desc">Generates images for the current story using Leonardo / Together AI.</p>
      <button class="run-btn" id="btn-image_generator" onclick="runScript('image_generator')">
        ‚ñ∂ Run
      </button>
    </div>

    <div class="card script-card" id="card-assembler">
      <div class="card-title">Script</div>
      <div class="script-header">
        <span class="script-name">Assembler</span>
        <span class="badge badge-idle" id="badge-assembler">
          <span class="dot"></span> Idle
        </span>
      </div>
      <p class="script-desc">Assembles clips, audio, and images into the final video.</p>
      <button class="run-btn" id="btn-assembler" onclick="runScript('assembler')">
        ‚ñ∂ Run
      </button>
    </div>

    <!-- ---- Scheduler Settings ---- -->
    <div class="card" id="card-settings">
      <div class="card-title">Scheduler Settings</div>
      <div style="display:flex;flex-direction:column;gap:0.6rem;">
        <label for="max-videos-input" style="font-size:0.82rem;color:var(--muted);">
          Videos published per day
        </label>
        <div style="display:flex;gap:0.5rem;align-items:center;">
          <input
            type="number"
            id="max-videos-input"
            min="1" max="20" value="4"
            style="width:72px;padding:0.38rem 0.6rem;background:#111;border:1px solid var(--border);
                   border-radius:6px;color:var(--text);font-size:0.9rem;outline:none;"
          />
          <button onclick="saveSettings()" class="run-btn"
                  style="padding:0.4rem 0.9rem;font-size:0.82rem;">
            Save
          </button>
          <span id="settings-status" style="font-size:0.75rem;"></span>
        </div>
        <p style="font-size:0.75rem;color:var(--muted);margin-top:0.1rem;">
          Scheduler reads this live ‚Äî no restart needed.
        </p>
      </div>
    </div>

    <!-- ---- Today's Adaptive Schedule ---- -->
    <div class="card" id="card-schedule">
      <div class="card-title">Today's Post Schedule</div>

      <!-- Tier badge -->
      <div style="margin-bottom:0.75rem;">
        <span id="sched-tier-badge" style="
          display:inline-block;
          font-size:0.7rem;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;
          padding:0.2rem 0.6rem;border-radius:20px;
          background:rgba(102,102,102,0.2);color:var(--muted);
        ">Loading‚Ä¶</span>
        <span id="sched-data-count" style="font-size:0.72rem;color:var(--muted);margin-left:0.5rem;"></span>
      </div>

      <!-- Time slots -->
      <div id="sched-slots" style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-bottom:0.75rem;">
        <span style="color:var(--muted);font-size:0.8rem;">‚Äî</span>
      </div>

      <!-- Source breakdown -->
      <div id="sched-source" style="font-size:0.75rem;color:var(--muted);line-height:1.6;"></div>

      <button onclick="loadSchedule()" style="
        margin-top:0.6rem;background:transparent;border:1px solid var(--border);
        border-radius:4px;color:var(--muted);font-size:0.72rem;padding:0.2rem 0.55rem;cursor:pointer;
      ">‚Üª Refresh</button>
    </div>

  </div>

  <!-- ---- Right top: Live Log ---- -->
  <div class="card log-card log-col">
    <div class="log-header">
      <span class="card-title" style="margin:0;">Live Output</span>
      <div style="display:flex;gap:0.5rem;align-items:center;">
        <span class="log-meta" id="log-meta">Waiting for run‚Ä¶</span>
        <button class="clear-btn" onclick="clearLog()">Clear</button>
      </div>
    </div>
    <div id="log-output"><span style="color:#444;">// Output will appear here when a script runs</span></div>
  </div>

  <!-- ---- Right bottom: History ---- -->
  <div class="card history-col">
    <div class="card-title">Run History</div>
    <div class="history-table-wrap">
      <table>
        <thead>
          <tr>
            <th>Script</th>
            <th>Started</th>
            <th>Duration</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="history-body">
          <tr class="empty-row"><td colspan="4">No runs yet.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</main>

<script>
  // ---- State ----
  let currentRunId = null;
  let currentScript = null;
  let eventSource = null;

  // ---- Helpers ----
  function setBadge(script, state) {
    const badge = document.getElementById('badge-' + script);
    if (!badge) return;
    badge.className = 'badge';
    badge.innerHTML = '';

    const dot = document.createElement('span');
    dot.className = 'dot';

    if (state === 'idle') {
      badge.classList.add('badge-idle');
      dot.classList.remove('dot-pulse');
      badge.appendChild(dot);
      badge.append(' Idle');
    } else if (state === 'running') {
      badge.classList.add('badge-running');
      dot.classList.add('dot-pulse');
      badge.appendChild(dot);
      badge.append(' Running');
    } else if (state === 'done') {
      badge.classList.add('badge-done');
      badge.appendChild(dot);
      badge.append(' Done');
    } else if (state === 'error') {
      badge.classList.add('badge-error');
      badge.appendChild(dot);
      badge.append(' Error');
    }
  }

  function setButtonsDisabled(disabled) {
    document.getElementById('btn-run_pipeline').disabled = disabled;
    document.getElementById('btn-image_generator').disabled = disabled;
    document.getElementById('btn-assembler').disabled = disabled;
  }

  function clearLog() {
    document.getElementById('log-output').innerHTML = '';
  }

  function appendLog(text, cls) {
    const el = document.getElementById('log-output');
    const line = document.createElement('div');
    line.textContent = text;
    if (cls) line.className = cls;
    el.appendChild(line);
    el.scrollTop = el.scrollHeight;
  }

  function fmtDuration(s) {
    if (s == null) return '‚Äî';
    if (s < 60) return s.toFixed(1) + 's';
    const m = Math.floor(s / 60);
    return m + 'm ' + (s % 60).toFixed(0) + 's';
  }

  function fmtTime(iso) {
    if (!iso) return '‚Äî';
    const d = new Date(iso);
    return d.toLocaleString();
  }

  // ---- Run a script ----
  async function runScript(script) {
    // Clear previous stream
    if (eventSource) { eventSource.close(); eventSource = null; }

    clearLog();
    document.getElementById('log-meta').textContent = 'Starting ' + script + '‚Ä¶';

    const resp = await fetch('/run/' + script, { method: 'POST' });
    const data = await resp.json();

    if (!resp.ok) {
      appendLog('[ERROR] ' + (data.error || 'Unknown error'), 'log-line-err');
      document.getElementById('log-meta').textContent = 'Failed to start.';
      return;
    }

    currentRunId = data.run_id;
    currentScript = script;

    setBadge(script, 'running');
    setButtonsDisabled(true);
    document.getElementById('log-meta').textContent = 'Streaming: ' + script + '‚Ä¶';

    // Connect SSE
    eventSource = new EventSource('/stream/' + currentRunId);

    eventSource.onmessage = function(e) {
      const text = e.data;
      let cls = '';
      const lower = text.toLowerCase();
      if (lower.includes('error') || lower.includes('traceback') || lower.includes('exception')) cls = 'log-line-err';
      else if (lower.includes('warn')) cls = 'log-line-warn';
      else if (lower.includes('done') || lower.includes('success') || lower.includes('complete')) cls = 'log-line-ok';
      appendLog(text, cls);
    };

    eventSource.addEventListener('done', function(e) {
      appendLog('', '');
      appendLog('[RUN COMPLETE]', 'log-line-ok');
      eventSource.close();
      eventSource = null;
      setBadge(script, 'done');
      setButtonsDisabled(false);
      document.getElementById('log-meta').textContent = 'Run finished.';
      loadHistory();
    });

    eventSource.onerror = function() {
      appendLog('[SSE connection lost]', 'log-line-err');
      if (eventSource) { eventSource.close(); eventSource = null; }
      setBadge(script, 'error');
      setButtonsDisabled(false);
      document.getElementById('log-meta').textContent = 'Connection error.';
      loadHistory();
    };
  }

  // ---- History ----
  async function loadHistory() {
    const resp = await fetch('/history');
    if (!resp.ok) return;
    const rows = await resp.json();
    const tbody = document.getElementById('history-body');
    if (rows.length === 0) {
      tbody.innerHTML = '<tr class="empty-row"><td colspan="4">No runs yet.</td></tr>';
      return;
    }
    tbody.innerHTML = rows.map(r => {
      const pillClass = r.status === 'success' ? 'status-success' : r.status === 'error' ? 'status-error' : 'status-running';
      return `<tr>
        <td class="script-cell">${r.script}</td>
        <td class="time-cell">${fmtTime(r.started_at)}</td>
        <td class="dur-cell">${fmtDuration(r.duration_s)}</td>
        <td><span class="status-pill ${pillClass}">${r.status}</span></td>
      </tr>`;
    }).join('');
  }

  // ---- Poll server status on load (in case a run is already active) ----
  async function checkServerStatus() {
    const resp = await fetch('/status');
    if (!resp.ok) return;
    const data = await resp.json();
    if (data.running_script) {
      // Another tab started a run ‚Äî disable buttons
      setBadge(data.running_script, 'running');
      setButtonsDisabled(true);
      document.getElementById('log-meta').textContent = data.running_script + ' is running‚Ä¶';

      // Reconnect SSE
      currentRunId = data.run_id;
      currentScript = data.running_script;
      clearLog();
      eventSource = new EventSource('/stream/' + currentRunId);

      eventSource.onmessage = function(e) { appendLog(e.data, ''); };
      eventSource.addEventListener('done', function() {
        eventSource.close(); eventSource = null;
        setBadge(currentScript, 'done');
        setButtonsDisabled(false);
        document.getElementById('log-meta').textContent = 'Run finished.';
        loadHistory();
      });
      eventSource.onerror = function() {
        if (eventSource) { eventSource.close(); eventSource = null; }
        setBadge(currentScript, 'error');
        setButtonsDisabled(false);
        document.getElementById('log-meta').textContent = 'Connection error.';
        loadHistory();
      };
    }
  }

  // ---- Adaptive Schedule ----
  async function loadSchedule() {
    try {
      const resp = await fetch('/api/schedule');
      if (!resp.ok) return;
      const d = await resp.json();

      // Tier badge
      const tierBadge = document.getElementById('sched-tier-badge');
      const tierMap = {
        'day-specific': { label: 'üß† AI Learned (' + d.today + ')', cls: 'background:rgba(76,175,80,0.2);color:#4caf50;' },
        'cross-day':    { label: 'üìà Partially Learned',              cls: 'background:rgba(33,150,243,0.2);color:#2196f3;' },
        'psychology':   { label: 'üîÆ Psychology Defaults',            cls: 'background:rgba(255,193,7,0.15);color:#ffc107;' },
      };
      const tier = tierMap[d.tier] || tierMap['psychology'];
      tierBadge.textContent = tier.label;
      tierBadge.setAttribute('style',
        'display:inline-block;font-size:0.7rem;font-weight:700;letter-spacing:0.06em;' +
        'text-transform:uppercase;padding:0.2rem 0.6rem;border-radius:20px;' + tier.cls
      );

      // Data count
      const countEl = document.getElementById('sched-data-count');
      if (d.data_driven) {
        countEl.textContent = `(${d.day_videos} ${d.today} posts tracked, ${d.any_videos} total)`;
      } else {
        countEl.textContent = `(${d.any_videos} posts tracked ‚Äî need more data to learn)`;
      }

      // Slot pills
      const slotsEl = document.getElementById('sched-slots');
      const nowH = new Date().getHours();
      const learnedSet = new Set(d.learned_hours || []);
      slotsEl.innerHTML = (d.schedule || []).map(slot => {
        const h = parseInt(slot);
        const isCurrent = h === nowH;
        const isLearned = learnedSet.has(slot);
        const cls = (isLearned ? 'slot-learned' : 'slot-psych') + (isCurrent ? ' slot-current' : '');
        return `<span class="slot-pill ${cls}">${slot}${isCurrent ? ' ‚óÄ' : ''}</span>`;
      }).join('') || '<span style="color:var(--muted);font-size:0.8rem;">No slots scheduled</span>';

      // Source breakdown
      const srcEl = document.getElementById('sched-source');
      const learnedStr = d.learned_hours && d.learned_hours.length
        ? `<span style="color:var(--green);">‚óè</span> Learned: ${d.learned_hours.join(', ')}`
        : `<span style="color:var(--muted);">‚óè No learned data yet</span>`;
      const psychStr = `<span style="color:var(--yellow);">‚óè</span> Psychology fill: ${(d.psych_hours || []).join(', ')}`;
      srcEl.innerHTML = learnedStr + '<br>' + psychStr;

    } catch (e) {}
  }

  // Auto-refresh schedule every 5 min
  setInterval(loadSchedule, 5 * 60 * 1000);

  // ---- Settings ----
  async function loadSettings() {
    try {
      const resp = await fetch('/api/settings');
      if (!resp.ok) return;
      const data = await resp.json();
      document.getElementById('max-videos-input').value = data.max_videos_per_day;
    } catch (e) {}
  }

  async function saveSettings() {
    const val = parseInt(document.getElementById('max-videos-input').value, 10);
    const statusEl = document.getElementById('settings-status');
    try {
      const resp = await fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ max_videos_per_day: val }),
      });
      const data = await resp.json();
      if (resp.ok) {
        statusEl.style.color = 'var(--green)';
        statusEl.textContent = '‚úì Saved';
      } else {
        statusEl.style.color = 'var(--red)';
        statusEl.textContent = data.error || 'Error';
      }
    } catch (e) {
      statusEl.style.color = 'var(--red)';
      statusEl.textContent = 'Network error';
    }
    setTimeout(() => { statusEl.textContent = ''; }, 2500);
  }

  // ---- Init ----
  loadHistory();
  loadSettings();
  loadSchedule();
  checkServerStatus();
</script>
</body>
</html>
